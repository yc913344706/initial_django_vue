# V1.1 版本需求文档

## 概述

现在我们的项目，是一个最小化全栈开发框架，关于用户管理，只有本地用户的增删改查，如果我想增加对接ldap的功能，是不是可以在 @code/frontend/src/views/system/user/index.vue 这个前端用户管理界面，增加一个配置ldap的功能？但是如果在这个界面进行配置，前端的展现形式就是一个按钮（如ldap配置），点击后有个弹窗，在弹窗中进行ldap的配置、同步等功能，是不是不太友好？是不是直接增加一个页面，比如 @code/frontend/src/views/system/user/config.vue 这样好点？

另外，ldap用户是否需要同步按钮？还是登录时候去ldap验证即可？这块应该是个业界比较通用的功能，你有什么建议吗？


## 需要澄清的问题

1. 认证模式：
    - LDAP是作为主要认证源还是补充认证源？
        - 这个是可配置的，初始化默认是无配置，用户体系是本系统的增删改查，但是当配置了ldap后，就支持ldap的用户登录。
        - 理想情况下，ldap应是主要认证源。
    - 本地用户和LDAP用户如何区分和管理？
        - 如何区分？都放到用户表中，然后用一个字段 is_ldap 来标记？
    - 是否支持混合认证（本地+LDAP）？
        - 支持

2. 同步策略：
    - 用户是否需要预同步到本地数据库？
        - 我理解不需要，每次登录的时候：
            - 先找本地数据库中是否有该用户：
                - 如果有，看该用户的 is_ldap 字段：
                    - 如果为true，则走ldap 认证用户密码，通过后，并更新本地数据库。
                    - 如果为false，则从本地数据库中获取用户信息。
                - 如果没有，则查询ldap中是否有该用户：
                    - 如果有，则走ldap 认证用户密码，通过后，并更新本地数据库。
                    - 如果没有，则返回用户不存在。
    - 还是每次登录时实时验证LDAP？
        - 登录时实时验证LDAP。本地数据库不存储 ldap 用户的密码。
    - 如需同步，同步频率和触发机制？
        - 我理解是不是不支持同步用户好点？

3. 权限映射：
    - LDAP用户如何映射到现有RBAC系统？
        - 现有rbac系统不用变，在对用户进行授权时，查询本地数据库，数据库中有的用户可以选择。
        - 所以就是说，如果想对某个用户进行授权，那么该用户必须先登录一下该系统，然后才能在rbac中授权。
        - 所以对于当前的rbac系统，我理解基础逻辑并未发生改变。
    - 如何处理角色和权限分配？
        - 我理解保持现状不用变。

4. 前端页面位置：
    - 建议在code/frontend/src/views/system/下创建独立的ldap/目录
    - 不建议放在user/目录下，因为配置和用户管理是不同功能域


1. 本地数据库不存储 ldap 用户的密码。
2. 同名冲突你有什么建议吗？我理解可以就规定：登录时，若本地数据库与ldap中有同名时，使用本地数据库用户，错了就错了，去找管理员解决，因为同名，肯定是因为管理员创建了同名用户。
3. 登录时，若ldap服务器不可用，可以提示出来，比如正常是：“用户输入密码错误”。ldap服务器不可用时，可以提示：“ldap服务器不可用，请联系管理员解决”
4. 认证失败的次数限制，这个好，我当前的代码机制都没有实现这个，可以这样，刚好我们本次要增加配置页面，把它也放到配置页面吧。